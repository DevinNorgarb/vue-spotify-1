<template lang="pug">
  .playlist.pa-4
    v-layout(row, wrap, align-center)
      v-flex(xs12, sm3)
        img(v-if='playlist.images[0]', :src='playlist.images[0].url')
        .no-image(v-else) No image found
      v-flex.px-4.text-sm-left.text-xs-center(xs12, sm9)
        .display-1 {{ playlist.name }}
      v-flex(md3, offset-md9, sm6, offset-sm6, xs12)
        v-text-field(v-model='search', placeholder='Filter tracks', append-icon='search', hide-details)
    v-data-table(:headers='headers', :items='tracks', :loading='loading', :search='search', no-data-text='Loading playlist...', hide-actions)
      template(slot='items', slot-scope='props')
        tr(@click='playSong(props.item.uri)')
          td {{ props.item.title }}
          td {{ props.item.artist }}
          td {{ props.item.album }}
          td.text-xs-right {{ props.item.duration }}
</template>

<script>
  import SpotifyService from '../services/SpotifyService'
  import WebPlaybackService from '../services/WebPlaybackService'
  import moment from 'moment'

  export default {
    name: 'playlist',
    props: ['id'],
    data () {
      return {
        headers: [
          {text: 'Title', value: 'title', align: 'left'},
          {text: 'Artist', value: 'artist', align: 'left'},
          {text: 'Album', value: 'album', align: 'left'},
          {text: 'Duration', value: 'duration', align: 'right'}
        ],
        playlist: {images: []},
        tracks: [],
        loading: true,
        search: '',
        audio: undefined
      }
    },
    async created () {
      // TODO consider caching images
      this.playlist = await SpotifyService.getPlaylist(this.id)
      this.tracks = this.playlist.tracks.items.map(item => {
        const durationMs = item.track.duration_ms
        const duration = moment.utc(durationMs).format(durationMs > 3600000 ? 'HH:mm:ss' : 'mm:ss')
        return {
          title: item.track.name,
          artist: item.track.artists.map(a => a.name).join(', '),
          album: item.track.album.name,
          uri: item.track.uri,
          duration
        }
      })
      this.loading = false
      this.audio = new Audio()
    },
    methods: {
      playSong: async function (uri) {
        console.log('Trying to play', uri)
        WebPlaybackService.playSong(uri)
      }
    }
  }
</script>

<style>
  .playlist table.datatable.table {
    background-color: transparent;
  }
</style>

<style scoped>
  img {
    width: 100%
  }

  .no-image {
    width: 100%;
    height: 100%;
    background-color: #c0ffee;
    line-height:240px;
    vertical-align: middle;
    text-align: center;
  }
</style>
